<!doctype html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <meta name="theme-color" content="#000000" />
        <meta
            name="description"
            content="Modern font editor for creating and editing fonts"
        />
        <meta name="apple-mobile-web-app-capable" content="yes" />
        <meta name="apple-mobile-web-app-status-bar-style" content="black" />
        <meta name="apple-mobile-web-app-title" content="counterpunch" />
        <title>Counterpunch Editor</title>
        <!-- Favicon -->
        <link rel="icon" type="image/svg+xml" href="assets/icons/icon.svg" />
        <link
            rel="icon"
            type="image/png"
            sizes="32x32"
            href="assets/icons/icon-32x32.png"
        />
        <!-- Development/Production detection helper (matches settings.ts logic) -->
        <script>
            // Shared helper functions to detect development/production mode
            // This is the single source of truth - settings.ts references these
            window.isDevelopment = function () {
                // URL parameter override for testing production mode locally
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.has('production')) {
                    console.log(
                        '[isDevelopment] URL param ?production detected - forcing production mode'
                    );
                    return false; // Force production mode
                }
                if (urlParams.has('development')) {
                    console.log(
                        '[isDevelopment] URL param ?development detected - forcing development mode'
                    );
                    return true; // Force development mode
                }

                const hostname = window.location.hostname;
                const port = window.location.port;
                const isDev =
                    hostname === 'localhost' ||
                    hostname === '127.0.0.1' ||
                    port === '8000' || // webpack dev server
                    port === '5500'; // live server
                console.log(
                    `[isDevelopment] Auto-detected: ${isDev ? 'development' : 'production'} (hostname: ${hostname}, port: ${port})`
                );
                return isDev;
            };
            window.isProduction = function () {
                return !window.isDevelopment();
            };
            window.isTestMode = function () {
                // Detect test mode via URL parameter
                const urlParams = new URLSearchParams(window.location.search);
                return urlParams.has('test');
            };
        </script>
        <!-- COI Service Worker for GitHub Pages (adds COOP/COEP headers) -->
        <!-- In development (localhost:8000), skip service worker - webpack provides headers -->
        <script>
            if (window.isDevelopment()) {
                console.log(
                    '[Init] Development mode - skipping service worker (webpack provides headers)'
                );
            } else {
                console.log('[Init] Production mode - loading service worker');
                const script = document.createElement('script');
                script.src = 'coi-serviceworker.js';
                script.onload = () =>
                    console.log('[Init] Service worker script loaded');
                script.onerror = (e) =>
                    console.error('[Init] Failed to load service worker:', e);
                document.head.appendChild(script);
            }
        </script>
        <!-- PWA Manifest -->
        <link rel="manifest" href="manifest.json" />
        <!-- Apple Touch Icons -->
        <link
            rel="apple-touch-icon"
            sizes="192x192"
            href="assets/icons/icon-192x192.png"
        />
        <link
            rel="apple-touch-icon"
            sizes="512x512"
            href="assets/icons/icon-512x512.png"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <!-- Funnel Display for loading screen and app name -->
        <link
            href="https://fonts.googleapis.com/css2?family=Funnel+Display:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <!-- Inter - Latin, Greek, Cyrillic (Regular + Bold for loading animation) -->
        <link
            href="https://fonts.googleapis.com/css2?family=Inter:wght@400;700&display=swap"
            rel="stylesheet"
        />
        <!-- IBM Plex Mono and Inter - All weights for UI -->
        <link
            href="https://fonts.googleapis.com/css2?family=IBM+Plex+Mono:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&family=Inter:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;1,100;1,200;1,300;1,400;1,500;1,600;1,700&display=swap"
            rel="stylesheet"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />
        <link
            rel="stylesheet"
            href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200"
        />
        <link rel="stylesheet" href="css/style.css" id="local-css" />
        <script src="https://cdn.jsdelivr.net/pyodide/v0.29.0/full/pyodide.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.42.0/js/jquery.terminal.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/jquery.terminal@2.42.0/js/unix_formatting.min.js"></script>
        <link
            href="https://cdn.jsdelivr.net/npm/jquery.terminal@2.42.0/css/jquery.terminal.min.css"
            rel="stylesheet"
        />

        <!-- HarfBuzz.js for text shaping (v0.4.13) -->
        <script src="https://cdn.jsdelivr.net/npm/harfbuzzjs@0.4.13/hb.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/harfbuzzjs@0.4.13/hbjs.js"></script>

        <!-- Ace Editor for Python -->
        <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/ace.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/mode-python.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/ace-builds@1.32.2/src-min-noconflict/theme-monokai.js"></script>

        <!-- Diff libraries -->
        <script src="https://cdn.jsdelivr.net/npm/diff@5.1.0/dist/diff.min.js"></script>
        <link
            rel="stylesheet"
            href="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/css/diff2html.min.css"
        />
        <script src="https://cdn.jsdelivr.net/npm/diff2html@3.4.47/bundles/js/diff2html-ui.min.js"></script>

        <!-- Markdown parser -->
        <script src="https://cdn.jsdelivr.net/npm/marked@11.1.1/marked.min.js"></script>

        <!-- Cache busting for local development only -->
        <script>
            (function () {
                if (window.isDevelopment()) {
                    const version = Date.now();
                    // Update CSS
                    const css = document.getElementById('local-css');
                    if (css) css.href = 'css/style.css?v=' + version;
                }
            })();
        </script>

        <!-- Extract and display version from service worker -->
        <script>
            (function () {
                // Fetch the service worker file to extract version
                fetch('coi-serviceworker.js')
                    .then((response) => response.text())
                    .then((text) => {
                        // Extract version from VERSION constant
                        const match = text.match(
                            /const\s+VERSION\s*=\s*['"](v[^\s'"]+)['"]/
                        );
                        if (match && match[1]) {
                            const versionSpan =
                                document.getElementById('app-version');
                            if (versionSpan) {
                                versionSpan.textContent = match[1];
                            }
                        }
                    })
                    .catch((err) =>
                        console.warn('Could not load version:', err)
                    );
            })();
        </script>

        <!-- Bootstrap Loading Animation -->
        <script>
            // Fade in loading screen when DOM is ready, before heavy scripts load
            (function() {
                let animationComplete = false;
                
                function fadeInLoadingScreen() {
                    if (animationComplete) return;
                    
                    const loadingIcon = document.querySelector('.loading-icon');
                    const loadingLogo = document.querySelector('.loading-logo');
                    
                    if (loadingIcon && loadingLogo) {
                        console.log('[Bootstrap] Starting fade-in animation');
                        
                        // Set transition properties
                        loadingIcon.style.transition = 'opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                        loadingLogo.style.transition = 'opacity 0.8s cubic-bezier(0.4, 0, 0.2, 1)';
                        
                        // First frame: ensure opacity is 0
                        requestAnimationFrame(() => {
                            loadingIcon.style.opacity = '0';
                            loadingLogo.style.opacity = '0';
                            
                            // Second frame: trigger fade to opacity 1
                            requestAnimationFrame(() => {
                                loadingIcon.style.opacity = '1';
                                loadingLogo.style.opacity = '1';
                                animationComplete = true;
                                
                                // After animation, show bootstrapping message
                                setTimeout(() => {
                                    console.log('[Bootstrap] Fade-in complete');
                                    const statusElement = document.getElementById('loading-status');
                                    if (statusElement && statusElement.textContent === '') {
                                        setTimeout(() => {
                                            if (statusElement.textContent === '') {
                                                statusElement.textContent = 'Bootstrapping...';
                                            }
                                        }, 100);
                                    }
                                }, 800);
                            });
                        });
                    } else {
                        console.warn('[Bootstrap] Loading elements not found');
                    }
                }
                
                // Always wait for DOMContentLoaded to ensure elements exist
                document.addEventListener('DOMContentLoaded', fadeInLoadingScreen);
            })();
        </script>
    </head>

    <body>
        <!-- Toolbar -->
        <div class="toolbar">
            <div class="toolbar-left">
                <h1 class="app-name">
                    Counterpunch 
                    <span style="opacity: 0.4"
                        >Alpha <span id="app-version"></span
                    ></span>
                    <button
                        id="update-app-btn"
                        class="update-button"
                        style="display: none"
                        title="New version available - click to reload"
                    >
                        <span class="material-symbols-rounded">autorenew</span>
                    </button>
                </h1>
            </div>
            <div class="toolbar-center"></div>
            <div class="toolbar-right">
                <button
                    id="save-font-btn"
                    class="toolbar-button"
                    title="Save font (Cmd+S)"
                    disabled
                >
                    Save
                </button>
                <div class="font-display-container">
                    <span
                        id="file-dirty-indicator"
                        class="file-dirty-indicator"
                        title="File has unsaved changes"
                        >‚óè</span
                    >
                    <div id="current-font-display" class="current-font-display">
                        <span class="font-icon"></span>
                        <span class="font-name">No fonts open</span>
                    </div>
                    <button
                        id="share-btn"
                        class="share-button"
                        title="Share font"
                    >
                        <span class="material-symbols-outlined">share</span>
                    </button>
                </div>
                <button
                    id="fullscreen-btn"
                    class="settings-button"
                    title="Toggle fullscreen"
                >
                    <span class="material-symbols-outlined">fullscreen</span>
                </button>
                <button
                    id="settings-btn"
                    class="settings-button"
                    title="Settings"
                >
                    <span class="material-symbols-outlined">settings</span>
                    <span
                        class="settings-memory-indicator"
                        id="settings-memory-indicator"
                    ></span>
                </button>
            </div>
        </div>

        <!-- Loading overlay -->
        <div id="loading-overlay" class="loading-overlay">
            <div class="loading-content">
                <img src="assets/icons/icon.svg" class="loading-icon" alt="Counterpunch icon" style="opacity: 0;" />
                <h1 class="loading-logo" style="opacity: 0;">Counterpunch</h1>
            </div>
            <div id="loading-status" class="loading-status"></div>
        </div>

        <div class="container">
            <!-- Top row with two views -->
            <div class="top-row">
                <div class="view view-fontinfo" id="view-fontinfo">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Font Info</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >I</span
                            >
                        </div>
                    </div>
                    <div class="view-content">
                        <div
                            id="browser-compat"
                            style="
                                margin-top: 20px;
                                padding: 10px;
                                border: 1px solid #0ff;
                                border-radius: 5px;
                                display: none;
                            "
                        >
                            <strong>‚ö†Ô∏è Browser Compatibility Notice</strong>
                            <p style="margin: 5px 0">
                                For best results, open this app in Chrome,
                                Firefox, or Safari.
                            </p>
                            <p style="margin: 5px 0">
                                SharedArrayBuffer support required for fontc
                                WASM threading.
                            </p>
                        </div>
                    </div>
                </div>
                <div
                    class="divider vertical-divider"
                    id="vertical-divider-1"
                ></div>
                <div class="view view-overview" id="view-overview">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Overview</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >O</span
                            >
                        </div>
                        <div class="view-title-right">
                            <div class="overview-search-control">
                                <span class="material-symbols-outlined overview-search-icon">search</span>
                                <input
                                    type="text"
                                    class="overview-search-input"
                                    id="overview-search-input"
                                    placeholder="Search glyphs..."
                                />
                            </div>
                            <div class="overview-size-control">
                                <input
                                    type="range"
                                    class="overview-size-slider"
                                    id="overview-size-slider"
                                    min="0"
                                    max="10"
                                    step="1"
                                    value="5"
                                />
                            </div>
                        </div>
                    </div>
                    <div class="view-content" id="overview-content"></div>
                </div>
                <div
                    class="divider vertical-divider"
                    id="vertical-divider-2"
                ></div>
                <div class="view view-editor" id="view-editor">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Editor</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >E</span
                            >
                            <button
                                id="editor-info-btn"
                                class="ai-info-button"
                                title="Keyboard shortcuts"
                            >
                                <span class="material-symbols-outlined"
                                    >help</span
                                >
                            </button>
                        </div>
                        <div class="editor-plugins-toggle">
                            <button
                                id="editor-plugins-dropdown-btn"
                                class="editor-plugins-dropdown-btn"
                                title="Canvas plugins"
                            >
                                Plugins
                                <span class="material-symbols-outlined"
                                    >expand_more</span
                                >
                            </button>
                            <div
                                id="editor-plugins-dropdown"
                                class="editor-plugins-dropdown"
                                style="display: none"
                            >
                                <!-- Plugin list will be populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                    <div class="view-content"></div>
                </div>
            </div>

            <!-- Horizontal divider -->
            <div
                class="divider horizontal-divider"
                id="horizontal-divider"
            ></div>

            <!-- Bottom row with four views -->
            <div class="bottom-row">
                <div class="view view-files" id="view-files">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Files</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >F</span
                            >
                        </div>
                        <div class="view-title-right">
                            <!-- Context tabs generated dynamically by file-browser.ts -->
                        </div>
                    </div>
                    <div class="view-content">
                        <div id="file-browser">
                            <div id="permission-banner">
                                <div class="permission-banner-content">
                                    <span class="material-symbols-outlined permission-banner-icon">lock</span>
                                    <span class="permission-banner-text">Folder access expired. Re-enable to continue.</span>
                                    <button class="permission-banner-button" onclick="window.reEnableAccess()">Re-enable</button>
                                </div>
                            </div>
                            <div id="plugin-message-container">
                                <!-- Dynamic plugin messages rendered here -->
                            </div>
                            <div id="open-folder-container">
                                <div class="open-folder-content">
                                    <span class="material-symbols-outlined open-folder-icon">folder_open</span>
                                    <h2>Open Folder</h2>
                                    <p>Select a folder from your computer to browse and edit fonts directly.</p>
                                    <button class="open-folder-button" onclick="window.selectDiskFolder()">
                                        <span class="material-symbols-outlined">folder_open</span>
                                        Select Folder
                                    </button>
                                </div>
                            </div>
                            <div id="file-tree"></div>
                        </div>
                    </div>
                </div>
                <div
                    class="divider vertical-divider"
                    id="vertical-divider-2"
                ></div>
                <div class="view view-assistant" id="view-assistant">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Assistant</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >A</span
                            >
                            <button
                                id="ai-info-btn"
                                class="ai-info-button"
                                title="Assistant info and settings"
                            >
                                <span class="material-symbols-outlined"
                                    >help</span
                                >
                            </button>
                        </div>
                        <div class="ai-title-buttons">
                            <button
                                id="ai-new-chat-btn"
                                class="view-title-button"
                                title="Start a new chat (Cmd+Alt+N)"
                            >
                                <span class="material-symbols-outlined"
                                    >add</span
                                >
                                <span class="button-shortcut" style="opacity: 0.5"
                                    ><span class="material-symbols-outlined"
                                        >keyboard_command_key</span
                                    ><span class="material-symbols-outlined"
                                        >keyboard_option_key</span
                                    >N</span
                                >
                            </button>
                            <button
                                id="ai-chat-history-btn"
                                class="view-title-button"
                                title="View chat history"
                            >
                                <span class="material-symbols-outlined"
                                    >history</span
                                >
                            </button>
                        </div>
                    </div>
                    <div class="view-content">
                        <!-- Login prompt for unauthenticated users -->
                        <div id="ai-login-container" style="display: none">
                            <div class="ai-login-content">
                                <span
                                    class="material-symbols-outlined ai-login-icon"
                                    >lock</span
                                >
                                <h2>Sign In Required</h2>
                                <p>
                                    You need to sign in with an active
                                    subscription to use the AI assistant.
                                </p>
                                <button
                                    id="ai-login-btn"
                                    class="ai-login-button"
                                >
                                    <span class="material-symbols-outlined"
                                        >login</span
                                    >
                                    Sign In
                                </button>
                                <p class="ai-login-note">
                                    You'll be redirected to sign in and then
                                    brought back here.
                                </p>
                            </div>
                        </div>

                        <!-- Subscription required message -->
                        <div
                            id="ai-subscription-container"
                            style="display: none"
                        >
                            <div class="ai-login-content">
                                <span
                                    class="material-symbols-outlined ai-login-icon"
                                    >workspace_premium</span
                                >
                                <h2>Advanced Subscription Required</h2>
                                <p>
                                    The assistant is available with an Advanced
                                    subscription. We offer a 30-day free trial!
                                </p>
                                <button
                                    id="ai-account-btn"
                                    class="ai-login-button"
                                >
                                    <span class="material-symbols-outlined"
                                        >manage_accounts</span
                                    >
                                    Manage Account
                                </button>
                                <p class="ai-login-note">
                                    Upgrade to Advanced to access the assistant.
                                </p>
                            </div>
                        </div>

                        <!-- Chat interface for authenticated users -->
                        <div id="ai-chat-container">
                            <!-- Context Selector (shown before first message) -->
                            <div
                                id="ai-context-selector"
                                class="ai-context-selector"
                            >
                                <h4>Choose your working context:</h4>
                                <div class="ai-context-radio-group">
                                    <label class="ai-context-radio-label">
                                        <input
                                            type="radio"
                                            name="ai-context"
                                            id="ai-context-radio-font"
                                            value="font"
                                            checked
                                        />
                                        <span class="ai-context-radio-custom">
                                            <!-- Populated by ChatSessionManager.getContextIconHTML('font') -->
                                            <strong>Font Context</strong>
                                            <small
                                                >Work directly on the current
                                                font</small
                                            >
                                        </span>
                                    </label>
                                    <label class="ai-context-radio-label">
                                        <input
                                            type="radio"
                                            name="ai-context"
                                            id="ai-context-radio-script"
                                            value="script"
                                        />
                                        <span class="ai-context-radio-custom">
                                            <!-- Populated by ChatSessionManager.getContextIconHTML('script') -->
                                            <strong>Script Context</strong>
                                            <small
                                                >Create or edit reusable
                                                scripts</small
                                            >
                                        </span>
                                    </label>
                                </div>
                                <p class="ai-context-note">
                                    This choice will be locked after your first
                                    message.
                                </p>
                            </div>

                            <div id="ai-messages"></div>

                            <div id="ai-input-container">
                                <!-- Locked Context Display (shown after first message) -->
                                <div
                                    id="ai-context-display"
                                    class="ai-context-display hidden"
                                >
                                    <span
                                        id="ai-context-display-icon"
                                        class="ai-context-display-icon ai-context-tag-font"
                                    >
                                        <span class="material-symbols-outlined"
                                            >font_download</span
                                        >
                                    </span>
                                    <span class="ai-context-display-text"
                                        >Font Context</span
                                    >
                                    <span class="ai-context-display-hint"
                                        >Start a new chat to change
                                        context</span
                                    >
                                </div>

                                <div id="ai-prompt-wrapper">
                                    <textarea
                                        id="ai-prompt"
                                        placeholder="Ask me anything about your font..."
                                        data-1p-ignore
                                    ></textarea>
                                </div>
                                <div class="ai-input-controls">
                                    <button
                                        id="ai-send-btn"
                                        class="ai-send-button"
                                    >
                                        <span class="material-symbols-outlined"
                                            >send</span
                                        >
                                        Send
                                        <span
                                            id="ai-send-btn-shortcut"
                                            class="button-shortcut ai-button-shortcut"
                                            style="display: none"
                                        >
                                            <span
                                                class="material-symbols-outlined"
                                                >keyboard_command_key</span
                                            >‚Üµ
                                        </span>
                                    </button>
                                    <button
                                        id="ai-model-btn"
                                        class="ai-model-btn"
                                        title="Select AI model"
                                    >
                                        <span id="ai-model-btn-name"
                                            >Loading...</span
                                        >
                                        <span class="material-symbols-outlined"
                                            >expand_more</span
                                        >
                                    </button>
                                    <label class="ai-auto-run-label">
                                        <input
                                            type="checkbox"
                                            id="ai-auto-run-checkbox"
                                            class="ai-auto-run-checkbox"
                                            checked
                                        />
                                        <span>Auto-run</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div
                    class="divider vertical-divider"
                    id="vertical-divider-3"
                ></div>
                <div class="view view-scripts" id="view-scripts">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Scripts</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >S</span
                            >
                            <button
                                id="script-api-docs-btn"
                                class="ai-info-button"
                                title="View API Documentation"
                            >
                                <span class="material-symbols-outlined"
                                    >help</span
                                >
                            </button>
                        </div>
                        <button
                            id="run-script-btn"
                            class="view-title-button"
                            title="Run script (Cmd+Alt+R)"
                        >
                            Run
                            <span class="button-shortcut" style="opacity: 0.5"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >keyboard_option_key</span
                                >R</span
                            >
                        </button>
                    </div>
                    <div id="script-editor"></div>
                </div>
                <div
                    class="divider vertical-divider"
                    id="vertical-divider-4"
                ></div>
                <div class="view view-console" id="view-console">
                    <div class="view-title-bar">
                        <div class="view-title-left">
                            <span class="view-title-name">Konsole</span>
                            <span class="view-title-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                ><span class="material-symbols-outlined"
                                    >arrow_upward</span
                                >K</span
                            >
                        </div>
                        <button
                            id="clear-console-btn"
                            class="view-title-button"
                            title="Clear console globally (Cmd+K)"
                        >
                            Clear
                            <span class="button-shortcut console-clear-shortcut"
                                ><span class="material-symbols-outlined"
                                    >keyboard_command_key</span
                                >K</span
                            >
                        </button>
                    </div>
                    <div id="console-container">
                        <div id="loading"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Webpack will inject bootstrap.js script here -->

        <!-- Diff Review Modal -->
        <div id="diff-review-modal" class="diff-modal">
            <div class="diff-modal-content">
                <div class="diff-modal-header">
                    <h2>Review Code Changes</h2>
                    <button class="diff-modal-close" id="diff-modal-close-btn">
                        ‚úï
                    </button>
                </div>
                <div class="diff-modal-body">
                    <div id="diff-container"></div>
                    <div id="diff-explanation" class="diff-explanation"></div>
                </div>
                <div class="diff-modal-footer">
                    <button
                        class="diff-modal-button diff-cancel-btn"
                        id="diff-cancel-btn"
                    >
                        Cancel
                    </button>
                    <button
                        class="diff-modal-button diff-accept-btn"
                        id="diff-accept-btn"
                    >
                        Open in Script Editor
                        <span class="button-shortcut ai-button-shortcut"
                            ><span class="material-symbols-outlined"
                                >keyboard_command_key</span
                            ><span class="material-symbols-outlined"
                                >keyboard_return</span
                            ></span
                        >
                    </button>
                </div>
            </div>
        </div>

        <!-- API Documentation Modal -->
        <div
            class="info-popup-overlay"
            id="api-docs-modal"
            style="display: none"
        >
            <div class="info-popup">
                <div class="info-popup-header">
                    <h3>Python API Documentation</h3>
                    <button
                        class="info-popup-close"
                        id="api-docs-modal-close-btn"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="info-popup-content">
                    <div class="ai-info-section">
                        <p>
                            View the complete Python API documentation for the
                            Font Object Model:
                        </p>
                        <p style="margin-top: 15px">
                            <a
                                href="https://github.com/yanone/context/blob/main/API.md"
                                target="_blank"
                                rel="noopener noreferrer"
                                style="
                                    color: var(--accent-blue);
                                    text-decoration: none;
                                    font-weight: 500;
                                "
                            >
                                üìñ Open API Documentation on GitHub
                            </a>
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Browser compatibility check -->
        <script>
            // Detect if we're in a limited browser context
            setTimeout(() => {
                const isVSCode =
                    navigator.userAgent.includes('Code') ||
                    navigator.userAgent.includes('Electron');
                const hasSAB = typeof SharedArrayBuffer !== 'undefined';
                const isIsolated =
                    typeof crossOriginIsolated !== 'undefined'
                        ? crossOriginIsolated
                        : false;

                // Log diagnostic info
                console.log('[COI Check] SharedArrayBuffer:', hasSAB);
                console.log('[COI Check] crossOriginIsolated:', isIsolated);
                console.log(
                    '[COI Check] Service Worker:',
                    navigator.serviceWorker?.controller
                        ? 'Active'
                        : 'Not active'
                );

                if (isVSCode || !hasSAB || !isIsolated) {
                    const notice = document.getElementById('browser-compat');
                    if (notice) {
                        notice.style.display = 'block';
                        if (isVSCode) {
                            notice.innerHTML =
                                '<strong>‚ö†Ô∏è VS Code Simple Browser Detected</strong>' +
                                '<p style="margin: 5px 0;">For fontc WASM compilation, please open this URL in a regular browser:</p>' +
                                '<p style="margin: 5px 0;"><code>http://localhost:8000</code></p>' +
                                '<p style="margin: 5px 0;">Recommended: Chrome, Firefox, or Safari</p>';
                        } else if (!isIsolated) {
                            notice.innerHTML =
                                '<strong>‚ö†Ô∏è Cross-Origin Isolation Required</strong>' +
                                '<p style="margin: 5px 0;">Service worker is activating. Please <strong>refresh the page manually</strong> (Cmd+R / F5).</p>' +
                                '<p style="margin: 5px 0; font-size: 0.9em;">This is needed to load the page through the service worker with proper headers.</p>';
                        }
                    }
                }
            }, 500);
        </script>

        <!-- AI Assistant Info Popup -->
        <div
            class="info-popup-overlay"
            id="ai-info-modal"
            style="display: none"
        >
            <div class="info-popup">
                <div class="info-popup-header">
                    <h3>AI Assistant</h3>
                    <button
                        class="info-popup-close"
                        id="ai-info-modal-close-btn"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="info-popup-content">
                    <div class="ai-info-section">
                        <h4>About</h4>
                        <p>
                            Describe what you want to do with your font in your
                            natural language. The assistant will generate Python
                            code using the <strong>context</strong> library and
                            run it.
                        </p>
                        <ul>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >adjust</span
                                >
                                <strong>Context matters:</strong> Work either on
                                the font directly (Font Context), or on a
                                user-made script in the script editor (Script
                                Context)
                            </li>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >sync</span
                                >
                                <strong>Auto-retry:</strong> If code fails, the
                                assistant will fix and retry
                            </li>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >key</span
                                >
                                <strong>Privacy:</strong> Your font data never
                                leaves the browser. The assistant simply
                                generates Python code which is run locally like
                                a user-made script.
                            </li>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >visibility</span
                                >
                                <strong>Transparent:</strong> Click "Show Code"
                                to see what was generated
                            </li>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >bolt</span
                                >
                                <strong>Auto-Run:</strong> Decide whether to run
                                the generated code right away or wait and review
                                before running
                            </li>
                            <li>
                                <span
                                    class="material-symbols-outlined ai-info-icon"
                                    >warning</span
                                >
                                <strong>Warning:</strong> The assistant makes
                                mistakes both in handling your data as well as
                                in generating code. Use at your own risk.
                            </li>
                        </ul>
                        <p class="ai-examples">
                            <em>Examples: </em
                            ><span class="ai-example-text"
                                >"List all glyph names", "Make glyphs 10%
                                wider", "Add 50 units to left
                                sidebearings"</span
                            >
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Matplotlib Plot Modal -->
        <div id="matplotlib-modal" class="matplotlib-modal">
            <div class="matplotlib-modal-content">
                <div class="matplotlib-modal-header">
                    <h3>Plot</h3>
                    <button
                        class="matplotlib-modal-close"
                        id="matplotlib-modal-close-btn"
                    >
                        &times;
                    </button>
                </div>
                <div class="matplotlib-modal-body" id="matplotlib-modal-body">
                    <!-- Plot canvas will be inserted here -->
                </div>
            </div>
        </div>

        <!-- Editor Keyboard Shortcuts Modal -->
        <div
            class="info-popup-overlay"
            id="editor-shortcuts-modal"
            style="display: none"
        >
            <div class="info-popup">
                <div class="info-popup-header">
                    <h3>Editor Keyboard Shortcuts</h3>
                    <button
                        class="info-popup-close"
                        id="editor-shortcuts-modal-close-btn"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div class="info-popup-content">
                    <div class="ai-info-section">
                        <h4>Text Mode</h4>
                        <ul>
                            <li>
                                <kbd>Cmd</kbd><kbd>Enter</kbd> Enter outline
                                editing mode at cursor position
                            </li>
                            <li>
                                <strong>Double-click on glyph outline:</strong>
                                Enter outline editing mode
                            </li>
                            <li><kbd>Esc</kbd> Exit outline editing mode</li>
                            <li>
                                <kbd>Shift</kbd> Sidebearing measurement tool
                                (after delay)
                            </li>
                        </ul>
                    </div>
                    <div class="ai-info-section">
                        <h4>Outline Editing Mode</h4>
                        <ul>
                            <li>
                                <strong>Double-click on component:</strong>
                                Enter nested component editing in-place
                            </li>
                            <li>
                                <kbd>Esc</kbd> Exit nested components editing
                            </li>
                            <li>
                                <kbd>Esc</kbd> Exit live interpolation to last
                                selected layer
                            </li>
                            <li>
                                <kbd>Cmd</kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_back</span
                                    ></kbd
                                >
                                / <kbd>Cmd</kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_forward</span
                                    ></kbd
                                >
                                Navigate glyphs like the text cursor moves
                            </li>
                            <li>
                                <kbd>Cmd</kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_upward</span
                                    ></kbd
                                >
                                / <kbd>Cmd</kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_downward</span
                                    ></kbd
                                >
                                Cycle through layers
                            </li>
                            <li>
                                <kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_upward</span
                                    ></kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_downward</span
                                    ></kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_back</span
                                    ></kbd
                                ><kbd
                                    ><span class="material-symbols-outlined"
                                        >arrow_forward</span
                                    ></kbd
                                >
                                Move selected objects (10x with
                                <kbd>Shift</kbd>)
                            </li>
                            <li><kbd>Space</kbd> Preview outline fill</li>
                            <li>
                                <kbd>Shift</kbd> Measurement tool (after delay,
                                custom line by click+drag)
                            </li>
                        </ul>
                    </div>
                    <div class="ai-info-section">
                        <h4>Panning and Zooming</h4>
                        <ul>
                            <li>
                                <kbd>Cmd</kbd><kbd>+</kbd>/<kbd>Cmd</kbd
                                ><kbd>-</kbd> Zoom in or out
                            </li>
                            <li>
                                <kbd>Cmd</kbd><kbd>0</kbd> Reset zoom and
                                position
                            </li>
                            <li>
                                <kbd>Space</kbd> +
                                <strong>Mouse drag:</strong> Pan canvas
                            </li>
                            <li>
                                <kbd>Alt</kbd> +
                                <strong>Wheel/Trackpad:</strong> Zoom in/out
                            </li>
                            <li>
                                <strong>Wheel</strong>: Pan vertically,
                                <kbd>Shift</kbd>+<strong>Wheel</strong>: Pan
                                horizontally
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Panel -->
        <div id="settings-panel" class="settings-panel">
            <div class="settings-panel-content">
                <div class="settings-section">
                    <div class="settings-item volume-control-item">
                        <label class="settings-item-label" for="volume-slider"
                            >Volume</label
                        >
                        <div class="volume-control-settings">
                            <span class="material-symbols-rounded volume-icon"
                                >volume_mute</span
                            >
                            <input
                                type="range"
                                id="volume-slider"
                                class="volume-slider-settings"
                                min="0"
                                max="100"
                                value="50"
                            />
                            <span class="material-symbols-rounded volume-icon"
                                >volume_up</span
                            >
                            <span class="volume-value">50%</span>
                        </div>
                        <div class="settings-item-description">
                            Adjust the volume for audio feedback
                        </div>
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">Account</label>
                        <div id="settings-login-section">
                            <div id="settings-logged-in" style="display: none">
                                <div
                                    class="settings-item-description"
                                    id="settings-user-email"
                                    style="margin-bottom: 4px"
                                >
                                    <!-- Email will be inserted here -->
                                </div>
                                <div
                                    class="settings-item-description"
                                    id="settings-credits"
                                    style="
                                        margin-bottom: 12px;
                                        font-size: 11px;
                                        opacity: 0.7;
                                    "
                                >
                                    <!-- Credits will be inserted here -->
                                </div>
                                <div style="display: flex; gap: 8px">
                                    <button
                                        id="settings-account-btn"
                                        class="tag-button"
                                        style="
                                            flex: 1;
                                            padding: 8px;
                                            font-size: 12px;
                                        "
                                    >
                                        <span
                                            class="material-symbols-rounded"
                                            style="
                                                font-size: 16px;
                                                vertical-align: middle;
                                                margin-right: 4px;
                                            "
                                            >manage_accounts</span
                                        >
                                        Account
                                    </button>
                                    <button
                                        id="settings-logout-btn"
                                        class="tag-button"
                                        style="
                                            flex: 1;
                                            padding: 8px;
                                            font-size: 12px;
                                        "
                                    >
                                        <span
                                            class="material-symbols-rounded"
                                            style="
                                                font-size: 16px;
                                                vertical-align: middle;
                                                margin-right: 4px;
                                            "
                                            >logout</span
                                        >
                                        Logout
                                    </button>
                                </div>
                            </div>
                            <div id="settings-logged-out" style="display: none">
                                <button
                                    id="settings-login-btn"
                                    class="tag-button"
                                    style="
                                        width: 100%;
                                        padding: 8px;
                                        font-size: 12px;
                                    "
                                >
                                    <span
                                        class="material-symbols-rounded"
                                        style="
                                            font-size: 16px;
                                            vertical-align: middle;
                                            margin-right: 4px;
                                        "
                                        >login</span
                                    >
                                    Login
                                </button>
                                <div
                                    class="settings-item-description"
                                    style="margin-top: 8px"
                                >
                                    Login with your Counterpunch account to use
                                    the assistant
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">Theme</label>
                        <div class="theme-switcher">
                            <button class="theme-option" data-theme="light">
                                <span class="material-symbols-rounded"
                                    >light_mode</span
                                >
                                Light
                            </button>
                            <button
                                class="theme-option active"
                                data-theme="dark"
                            >
                                <span class="material-symbols-rounded"
                                    >dark_mode</span
                                >
                                Dark
                            </button>
                            <button class="theme-option" data-theme="auto">
                                <span class="material-symbols-rounded"
                                    >brightness_auto</span
                                >
                                Auto
                            </button>
                        </div>
                        <div class="settings-item-description">
                            Choose between light, dark, or automatic theme based
                            on your system preferences
                        </div>
                    </div>
                    <div class="settings-item">
                        <label class="settings-item-label">
                            Memory
                            <button
                                class="info-icon-btn"
                                id="memory-info-btn"
                                title="Memory usage information"
                            >
                                <span class="material-symbols-outlined"
                                    >help</span
                                >
                            </button>
                        </label>
                        <div class="memory-display-settings">
                            <div class="memory-bar-container">
                                <div
                                    class="memory-bar"
                                    id="settings-memory-bar"
                                ></div>
                            </div>
                            <div
                                class="memory-percentage"
                                id="settings-memory-percentage"
                            >
                                ---%
                            </div>
                        </div>
                        <div
                            class="memory-details"
                            id="settings-memory-details"
                        >
                            Loading...
                        </div>
                        <div class="settings-item-description">
                            Close all editor browser tabs at 90% to prevent
                            crashes. Remember to save your data.
                        </div>
                    </div>

                    <!-- Memory Info Popup -->
                    <div
                        class="info-popup-overlay"
                        id="memory-info-popup"
                        style="display: none"
                    >
                        <div class="info-popup">
                            <div class="info-popup-header">
                                <h3>Memory Usage</h3>
                                <button
                                    class="info-popup-close"
                                    id="memory-info-close"
                                >
                                    <span class="material-symbols-outlined"
                                        >close</span
                                    >
                                </button>
                            </div>
                            <div class="info-popup-content">
                                <p>
                                    This shows how much browser memory the font
                                    editor is using.
                                </p>

                                <h4>Understanding Memory Usage</h4>
                                <ul>
                                    <li>
                                        <strong>Used Memory:</strong> Current
                                        memory allocated by the app
                                    </li>
                                    <li>
                                        <strong>Memory Limit:</strong> Maximum
                                        memory allowed by your browser
                                    </li>
                                    <li>
                                        <strong>Percentage:</strong> How close
                                        you are to the limit
                                    </li>
                                </ul>

                                <h4>‚ö†Ô∏è Important: Shared Memory</h4>
                                <p>
                                    A significant portion of memory is
                                    <strong
                                        >shared across all browser tabs</strong
                                    >
                                    running this app. This includes:
                                </p>
                                <ul>
                                    <li>Python runtime (Pyodide)</li>
                                    <li>Core libraries and modules</li>
                                    <li>Compiled WebAssembly code</li>
                                </ul>

                                <p class="info-highlight">
                                    üí° To fully free memory, you must
                                    <strong>close ALL tabs</strong> with this
                                    app, then reopen in a fresh tab.
                                </p>

                                <h4>When to Worry</h4>
                                <ul>
                                    <li>
                                        <span style="color: var(--accent-green)"
                                            >üü¢ Below 70%:</span
                                        >
                                        Safe, normal operation
                                    </li>
                                    <li>
                                        <span
                                            style="color: var(--accent-yellow)"
                                            >üü° 70-90%:</span
                                        >
                                        Warning, consider saving and restarting
                                    </li>
                                    <li>
                                        <span style="color: var(--accent-red)"
                                            >üî¥ Above 90%:</span
                                        >
                                        Critical, close all tabs and restart
                                    </li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PWA Service Worker Registration -->
        <script>
            // PWA Install Prompt Handler
            let deferredPrompt;

            window.addEventListener('beforeinstallprompt', (e) => {
                // Prevent Chrome's default install prompt
                e.preventDefault();
                // Store the event for later use
                deferredPrompt = e;
                console.log('[PWA] Install prompt available');

                // You can show your own custom install button here
                // Example: showInstallButton();
            });

            // Function to trigger install (call this from a button click)
            window.installPWA = async () => {
                if (!deferredPrompt) {
                    console.log('[PWA] Install prompt not available');
                    return;
                }

                // Show the install prompt
                deferredPrompt.prompt();

                // Wait for the user's response
                const { outcome } = await deferredPrompt.userChoice;
                console.log(`[PWA] User response: ${outcome}`);

                // Clear the prompt
                deferredPrompt = null;
            };

            // Listen for app installation
            window.addEventListener('appinstalled', (e) => {
                console.log('[PWA] App installed successfully');
                deferredPrompt = null;
            });

            // Service Worker Registration
            if ('serviceWorker' in navigator) {
                window.addEventListener('load', () => {
                    // Check service worker status
                    if (navigator.serviceWorker.controller) {
                        console.log(
                            '[PWA] Service worker active - offline mode available'
                        );

                        // Listen for service worker updates
                        navigator.serviceWorker.addEventListener(
                            'message',
                            (event) => {
                                if (
                                    event.data &&
                                    event.data.type === 'OFFLINE_READY'
                                ) {
                                    console.log(
                                        '[PWA] ‚úÖ App fully cached and ready for offline use'
                                    );
                                } else if (
                                    event.data &&
                                    event.data.type === 'SW_UPDATED'
                                ) {
                                    const newVersion = event.data.version;
                                    console.log(
                                        '[PWA] üîÑ New version available:',
                                        newVersion
                                    );
                                    // Show update button
                                    const updateBtn =
                                        document.getElementById(
                                            'update-app-btn'
                                        );
                                    if (updateBtn) {
                                        updateBtn.style.display = 'inline-flex';
                                        updateBtn.onclick = () => {
                                            window.location.reload();
                                        };

                                        // Update button title with version and link
                                        const releaseUrl = `https://github.com/yanone/context/releases/tag/${newVersion}`;
                                        updateBtn.title = `New version ${newVersion} available - click to reload`;

                                        // Add release notes link
                                        let releaseLink =
                                            document.getElementById(
                                                'release-notes-link'
                                            );
                                        if (!releaseLink) {
                                            releaseLink =
                                                document.createElement('a');
                                            releaseLink.id =
                                                'release-notes-link';
                                            releaseLink.className =
                                                'release-notes-link';
                                            releaseLink.target = '_blank';
                                            releaseLink.rel =
                                                'noopener noreferrer';
                                            updateBtn.parentNode.insertBefore(
                                                releaseLink,
                                                updateBtn.nextSibling
                                            );
                                        }
                                        releaseLink.href = releaseUrl;
                                        releaseLink.textContent = `Release notes`;
                                        releaseLink.style.display =
                                            'inline-flex';
                                    }
                                }
                            }
                        );

                        // Listen for controller change (new SW taking control)
                        navigator.serviceWorker.addEventListener(
                            'controllerchange',
                            () => {
                                console.log(
                                    '[PWA] üîÑ New service worker activated'
                                );
                                // Show update button
                                const updateBtn =
                                    document.getElementById('update-app-btn');
                                if (
                                    updateBtn &&
                                    updateBtn.style.display !== 'inline-flex'
                                ) {
                                    updateBtn.style.display = 'inline-flex';
                                    updateBtn.onclick = () => {
                                        window.location.reload();
                                    };
                                    // Try to get version from the app-version span
                                    const versionSpan =
                                        document.getElementById('app-version');
                                    if (
                                        versionSpan &&
                                        versionSpan.textContent
                                    ) {
                                        const releaseUrl = `https://github.com/yanone/context/releases/tag/${versionSpan.textContent}`;
                                        updateBtn.title = `New version available - click to reload`;
                                    }
                                }
                            }
                        );
                    } else {
                        console.log('[PWA] Service worker registering...');
                    }
                });

                // Check for service worker updates periodically
                navigator.serviceWorker.ready.then((registration) => {
                    // Periodic update check every 10 minutes
                    setInterval(
                        () => {
                            console.log('[PWA] Checking for updates...');
                            registration.update().catch((error) => {
                                console.warn(
                                    '[PWA] Update check failed:',
                                    error
                                );
                            });
                        },
                        10 * 60 * 1000
                    ); // 10 minutes

                    // Also check when window regains focus (user switches back to app)
                    let lastFocusCheck = Date.now();
                    window.addEventListener('focus', () => {
                        // Throttle to avoid too many checks (min 30 seconds between checks)
                        const now = Date.now();
                        if (now - lastFocusCheck > 30000) {
                            lastFocusCheck = now;
                            console.log(
                                '[PWA] Window focused - checking for updates...'
                            );
                            registration.update().catch((error) => {
                                console.warn(
                                    '[PWA] Update check failed:',
                                    error
                                );
                            });
                        }
                    });
                });
            }
        </script>

        <!-- Model Picker Modal -->
        <div
            id="ai-model-picker-overlay"
            class="ai-model-picker-overlay"
            style="display: none"
        >
            <div class="ai-model-picker">
                <div class="ai-model-picker-header">
                    <h3>Select AI Model</h3>
                    <button
                        id="ai-model-picker-close"
                        class="ai-model-picker-close"
                    >
                        <span class="material-symbols-outlined">close</span>
                    </button>
                </div>
                <div id="ai-model-picker-list" class="ai-model-picker-list">
                    <!-- Model options populated dynamically -->
                </div>
            </div>
        </div>

        <!-- Chat History Menu -->
        <div
            id="ai-chat-history-menu"
            class="ai-chat-history-menu"
            style="display: none"
        >
            <div class="ai-chat-history-header">
                <h3>Chat History</h3>
                <button
                    id="ai-chat-history-close-btn"
                    class="ai-chat-history-close"
                >
                    <span class="material-symbols-outlined">close</span>
                </button>
            </div>
            <div id="ai-chat-history-list" class="ai-chat-history-list">
                <!-- Chat history items will be populated here -->
            </div>
        </div>
        <div
            id="ai-chat-history-backdrop"
            class="ai-chat-history-backdrop"
            style="display: none"
        ></div>

        <!-- Include translations and Chat Session Manager -->
        <script src="js/translations.js"></script>
        <script src="js/chat-session-manager.js"></script>
        <script src="js/glyph-overview.js"></script>
        <script src="js/overview-view.js"></script>
    </body>
</html>
